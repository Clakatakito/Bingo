LDAP ACCOUNT MANAGER

El servicio LDAP, nos facilita el control de acceso entre usuarios en la red, para poder utilizar a los usuarios en diferentes máquinas conectados a la red guardando los datos de cada uno y facilita la gestión de los usuarios, lo implementaremos de la siguiente manera:

Configuración hecha en el servidor

Empezamos utilizando la siguiente comanda para asegurarnos de que todo esté bien actualizado y no dé problemas:
    -sudo apt update && sudo apt upgrade

Instalamos los paquetes necesarios:
    -sudo apt install apache2 php php-cgi libapache2-mod-php php-mbstring php-common php-pear ldap-utils

Para saber qué versión de apache2 tienes:
    -sudo php -v

Activamos la configuración php:
    -sudo a2enconf php8.1-cgi (la version de php que tengas)

Reiniciamos el servicio apache2 para recoger las configuraciones:
    -sudo systemctl reload apache2

Instalamos LDAP y la GUI de ldap cuando nos pida la contraseña pondremos la deseada para entrar en el servidor LDAP:
    -sudo apt install ldap-account-manager

    -sudo nano /etc/apache2/conf-enabled/ldap-account-manager.conf

En la parte de Requere all garanted lo cambiamos por ip, pondremos la ip de localhost y la ip desde la maquina que queremos entrar al servidor LDAP:

    -Require ip 127.0.0.1 192.168.0.2/24 (direccion_ip_desde_la_que_quiere_entrar(192.168.XXX.XXX)

I reiniciamos:
    -sudo systemctl restart apache2.service

Configuración hecha en el cliente

Empezamos utilizando el siguiente comando, para asegurarnos de que todo esté bien actualizado y no dé problemas:
    -sudo apt update && sudo apt upgrade && sudo apt install ldap-utils

En tu navegador web de confianza buscamos la dirección ip del servidor seguido de lam:

ip-del-serverlam

Nos saldra es login de ACCOUNT MANAGER y iremos arriba a la derecha ha "LAM configuration" y a "Edit general settings" con la contraseña "lam", aqui bajamos asta abajo del todo a "Change master password" y pondremos
la que mas nos interese, normalmete la misma que la del slapd

I haremos lo mismo, iremos a "LAM configuration" y ha "Edit server profile" con la contraseña "lam": nos configuraremos el lenguaje en "Languaje settings" del que queramos, en "Tool settings" pondremos el dominio del
servidor: "dc=tudominio,dc=com", en "Security settings" lo mismo pero con el usuario responsable: "cn=admin,dc=as,dc=es" y en "Profile password" combiamos la contraseña y a Safe.

Volveremos a "LAM configuration" y ha "Edit server profile" y entraremos a "Tipos de cuenta" y ha "Tipos de cuentas activas" en "Sufijo LDAP" tanto en "Usuarios" como en "Grupos" borraremos la ou de los dos y pondremos
nuetro dominio.

Nos vamos al servidor y instalamos ldap:
    -sudo apt install slapd

I acto seguido:
    -sudo dpkg-reconfigure slapd

Primera:
    NO

Segunda:
    Tu dns (tudominio.cat)

Tercera:
    La ou padre que quieras

Cuarta:
    Contraseña

Quinta:
    Repetir contraseña

I nos logeamos con aquella contraseña en LAM.

Como no tenemos ninguna ou_padre por la que partir, si nos vamos a "Herramientas" "Editor de OU" esta en blanco, es porque no tenemos ninguna asique crearemos un fichero .ldif en "/etc/"
    -sudo nano ou.ldif

I en ese fichero pondremos:

dn: ou=ou_padre,dc=dominio,dc=cat
objectClass: top
objectClass: organizationalUnit
ou: ou_padre

Guardamos y en la linea de comandos lo metemos en la base de datos:
    -sudo ldapadd -x -D cn=admin,dc=dominio,dc=cat -W -f ou.ldif

Ahora haremos lo mismo para crear un grupo y usaremos de plantilla de "ou.ldif":
    -sudo cp ou.ldif group.ldif

dn: cn=Administradores,ou=ou_padre,dc=dominio,dc=cat
objectClass: top
objectClass: posixGroup
gidNumber: 10000
cn: Administradores

I ya nos saldra, podremos crear: usuario, grupos, ou's, gestionarlas entre otros, pero vamos a crear un usuario:

En "Usuario" "Nuevo usuario":

Nos crearemos el usuario como queramos:

Por ejemplo crearemos el usuario pepe de contraseña pepe y de nombre de usuario pepe:


Luego de eso iremos a la terminal y instalamos los paquetes necesarios para que los clientes se comuniquen con el servicio LDAP:
    -sudo apt install libnss-ldap libpam-ldap ldap-utils

Primera:
    ldap://ip-de-tu-servidor/

Segunda:
    dc=dominio,dc=cat

Tercera:
    3

Cuarta:
    Si

Quinta:
    No

Sexta:
    cn=admin,dc=dominio,dc=cat

Septima:
    Contraseña

Accederemos a este archivo de configuración y le diremos que coja las contraseñas y grupos de LDAP:
    -sudo nano /etc/nsswitch.conf

    -passwd:        files ldap
    -group:         files ldap
    -shadow:        files ldap

Despues de hacer eso si ponemos la comanda de abajo podemos ver los usuarios en la red (a nuetros usuarios creados):
    -sudo nano getent passwd

    -sudo nano /etc/pam.d/common-session

Al final del archivo pondremos:

    -session optional    pam_mkhomedir.so skel=/etc/skel umask=077

    -sudo apt install nslcd:

Rellenamos las credenciales que tendrian que estar rellenadas ya y hacemos reboot

Así tendremos funcionando el servicio LDAP
